<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="initial-scale=1.0">
    <!-- Add jquery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <title>TMDB</title>
    <header><h1>TMDB</h1></header>

<body>
    <main>
        <!-- Add search input -->
        <input type="text" id="search" placeholder="Search for a movie">
        <button id="searchBtn">Search</button>
        <div>
            <!-- Add results here -->
            <p id="results"></p>
        </div>
    </main>
    <script>
        var API_KEY = "b47e20bd83e9aac5340afcb226fa4def";
        var BASE_URL = "https://api.themoviedb.org/3";
        var IMAGE_URL = "https://image.tmdb.org/t/p/w500";
        console.log("script");
        var movies = {};

        $("#results").text("Hello");

        // Add searchBtn listener
        $("#searchBtn").on("click", function (event) {
            event.preventDefault();
            $("#results").empty();
            movies = {};
            var query = $("#search").val().trim();
            var queryURL = `${BASE_URL}/search/movie?query=${query}&api_key=${API_KEY}&language=en-US&page=1&include_adult=false`;
            $("#results").text("URL:" + queryURL);
            fetch(queryURL)
                .then(function (response) {
                    return response.json();
                })
                .then(function (data) {
                    console.log(data);
                    var result = JSON.stringify(data);
                    for (var i = 0; i < data.results.length; i++) {
                        var movie = data.results[i];
                        movies[movie.id] = movie;
                        // Find streaming services
                        var streamingURL = `${BASE_URL}/movie/${movie.id}/watch/providers?api_key=${API_KEY}`;
                        fetch(streamingURL)
                            .then(function (response) {
                                return response.json();
                            })
                            .then(function (data) {
                                // var streamingDiv = $("<div>");
                                var streamingServices = data.results.US.flatrate;
                                if (streamingServices) {
                                    console.log(streamingServices);
                                    movie = movies[data.id];
                                    var movieDiv = $("<div>");
                                    var titleDiv = $("<a>")
                                        .attr("href", `https://www.themoviedb.org/movie/${movie.id}`)
                                        .append($("<h3>").text(movie.title));
                                   
                                    var posterDiv = $("<img>")
                                        .attr("src", IMAGE_URL + movie.poster_path)
                                        .attr("width", "80px");
                                    var overviewDiv = $("<p>").text(movie.overview);
                                    var releaseDateDiv = $("<p>")
                                   
                                    var streamingDiv = $("<div>");
                                    if (streamingServices) {
                                        for (var i = 0; i < streamingServices.length; i++) {
                                            var streamingService = streamingServices[i];
                                            var streamingServiceName = streamingService.provider_name;
                                            var streamingName = $("<p>");
                                            var streamingServiceLogo = streamingService.logo_path;
                                            var streamingServiceLogoDiv = $("<img>")
                                                .attr("src", IMAGE_URL + streamingServiceLogo)
                                                .attr("width", "40px");
                                            streamingDiv.append(streamingServiceLogoDiv);
                                        }
                                    }
                                    movieDiv.append(titleDiv, posterDiv, overviewDiv, releaseDateDiv, streamingDiv);

                                    $("#results").append(movieDiv);
                                }
                            });

                    }
                });
        });
    </script>
</body>

</html>